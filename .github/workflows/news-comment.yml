name: Science News Bot

on:
  schedule:
    - cron: '0 * * * *'  # –ö–∞–∂–¥—ã–π —á–∞—Å
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  run-bot:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install google-generativeai requests beautifulsoup4 lxml
    
    - name: Check Facts.txt
      run: |
        echo "üìä –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ Facts.txt:"
        echo "–†–∞–∑–º–µ—Ä: $(wc -c < Facts.txt) –±–∞–π—Ç"
        md5sum Facts.txt
    
    - name: Create necessary directories
      run: |
        mkdir -p commentary
        echo "üìÅ –ü–∞–ø–∫–∞ commentary —Å–æ–∑–¥–∞–Ω–∞"
    
    - name: Run Science News Bot
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}
      run: |
        echo "=== –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ ==="
        echo "üìä –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ Facts.txt:"
        echo "–†–∞–∑–º–µ—Ä: $(wc -c < Facts.txt) –±–∞–π—Ç"
        md5sum Facts.txt
        python news_bot.py
    
    - name: Check created files
      run: |
        echo "üìÅ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:"
        ls -la
        echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ commentary:"
        ls -la commentary/ || echo "–ü–∞–ø–∫–∞ commentary –ø—É—Å—Ç–∞ –∏–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
        echo "üìÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º processed_news.json:"
        if [ -f "processed_news.json" ]; then
          echo "‚úÖ processed_news.json —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
          wc -l processed_news.json
          head -5 processed_news.json
        else
          echo "‚ùå processed_news.json –Ω–µ –Ω–∞–π–¥–µ–Ω"
        fi
    
    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: Commit and push changes
      run: |
        git add .
        if git diff --staged --quiet; then
          echo "üìù –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
        else
          echo "üìù –ö–æ–º–º–∏—Ç–∏–º –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã:"
          git status
          git commit -m "ü§ñ –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ Alexey Turchin ($(date '+%Y-%m-%d %H:%M'))"
          git push
          echo "‚úÖ –§–∞–π–ª—ã —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π!"
        fi
